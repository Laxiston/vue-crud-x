var e=Object.prototype.hasOwnProperty,l=Object.getOwnPropertySymbols,t=Object.prototype.propertyIsEnumerable;import{M as a,N as o,O as s,r,P as n,e as i,o as c,Q as d,h as u,k as m,l as p,n as b,q as f,s as g,t as v,w as y,v as h,F as w,G as C,R as k,y as O,A as F,x,S as U,z as S}from"./index.a19c4582.js";import{d as q,a as j}from"./util.2f5ed4e1.js";let V="",P=null;function $(e,l,t,a){let o="";for(const s in e)if("string"===l?"min"===s&&a[t].length<e[s]?o=`need at least ${e[s]} characters`:"max"===s&&a[t].length>e[s]?o=`maximum ${e[s]} characters`:"regex"!==s||RegExp(e[s]).test(a[t])||(o=`regex ${e[s]} failed`):["integer","decimal","datetime","date","time"].includes(l)&&("min"===s&&a[t]<e[s]?o=`cannot be less than ${e[s]}`:"max"===s&&a[t]>e[s]?o=`cannot be more than ${e[s]}`:"gt"!==s||!a[e[s]]||a[t]>a[e[s]]?"gte"!==s||!a[e[s]]||a[t]>=a[e[s]]?"lt"!==s||!a[e[s]]||a[t]<a[e[s]]?"lte"!==s||!a[e[s]]||a[t]<=a[e[s]]||(o=`${t} must be <= ${e[s]}`):o=`${t} must be < ${e[s]}`:o=`${t} must be >= ${e[s]}`:o=`${t} must be > ${e[s]}`),o)break;return o}const A={name:"CrudTable",props:{infinite:{type:Boolean,default:!1},pageStart:{type:String,default:"1"},pageSize:{type:Number,default:10},pageSizeList:{type:Array,default:()=>[5,10,25,50]},tableName:{type:String,required:!0}},setup(m,p){const b=d(),f=u(),g=r(null),v=r(null),y=r(null),h=r(m.infinite?m.pageStart:Number(m.pageStart)),w=r([]),C=r(1),k=r(m.pageSize),O=n([]),F=n([]),x=n([]),U=r(["=","like","!=",">=",">","<=","<"]),S=r(!1),A=r(""),_=r(!1),N=n({add:{},edit:{}});let E,R=[];const I=async e=>{const l=e.detail.value;if(e.stopPropagation(),!_.value){if(!y.value.update)return console.log("no update permission");if(!l&&y.value.multiSelect)return console.log("click item null");if(y.value.multiSelect?E.activeItem=null:(console.log("single"),E.selectedItems=l?[l]:[]),l)try{const t=await async function(l){let t={};try{const{data:e}=await a("/api/t4t/find-one/"+V,{__key:l});return t.__key=l,Object.entries(P.cols).forEach((l=>{const[a,o]=l;"hide"!==o.edit&&(t[a]=e[a])})),t}catch(e){return null}}(l.__key);t&&(N.edit=t,A.value="edit")}catch(t){console.log(t.toString())}}};i((async()=>{var e;if(console.log("Crud Table route",f.query),g.value=f.query.keycol,v.value=f.query.keyval,e=m.tableName,V=e,y.value||(y.value=await async function(){try{const{data:e}=await a("/api/t4t/config/"+V);return e&&(P=e),P}catch(e){}return null}()),y.value)for(const l in y.value.cols){const e=y.value.cols[l];e.hide||O.push({path:l,header:e.label,width:e.width?e.width+"px":null}),e.filter&&x.push(l)}E=document.querySelector("vaadin-grid.table"),E&&(E.addEventListener("active-item-changed",I),E.dataProvider=async function(e,l){if(_.value)return;_.value=!0;try{E.selectedItems=[],R=[],e.sortOrders&&e.sortOrders.length&&e.sortOrders[0].direction&&R.push({column:e.sortOrders[0].path,order:e.sortOrders[0].direction});const t=await async function(e,l,t,o){let s={results:[],total:0};try{const{data:r}=await a("/api/t4t/find/"+V,{page:t,limit:o,filters:JSON.stringify(e),sorter:JSON.stringify(l)});s.results=r.results,s.total=r.total}catch(r){}return s}(g.value?[...F,{col:g.value,op:"=",val:v.value,andOr:"and"}]:F,R,h.value,k.value);t.results&&(C.value=Math.ceil(t.total/k.value),console.log("rv.total",t.total,k.value,C.value),E.size=t.results.length,w.value=t.results,t.cursor&&m.infinite&&(h.value=t.cursor),l(t.results))}catch(o){console.log(o.toString())}const t=E.querySelector("vaadin-grid-selection-column");t?(t.removeEventListener("select-all-changed",L),t.addEventListener("select-all-changed",L),t.selectAll=!1,E.selectedItems=[]):console.log("vaadin-grid-selection-column Mount ERROR"),_.value=!1})})),c((()=>{E&&E.removeEventListener("active-item-changed",I)}));const D=()=>E&&E.clearCache(),z=q((async(e,l,t)=>{const o=await async function(e,l,t){let o=[];try{const{dbName:s,tableName:r,limit:n,key:i,text:c,parentTableColName:d,parentCol:u}=P.cols[l].options,m={dbName:s,tableName:r,limit:n,key:i,text:c,search:e};d&&(m.parentTableColName=d,m.parentTableColVal=t[u]);const{data:p}=await a("/api/t4t/autocomplete",m);o=p}catch(s){console.log("autocomplete",s.message)}return o}(e.target.value,l,N[t]);document.querySelector("mwc-autocomplete."+l).setList(o)}),500),L=e=>{if(!E)return;const l=E.querySelector("vaadin-grid-selection-column");if(console.log("selAll",l.selectAll),l.selectAll){const e=E.querySelectorAll("vaadin-checkbox");let t=0;for(const a of e)0!==t&&(a.checked=l.selectAll),t++}E.selectedItems=E.selectedItems.filter((e=>!!e)),console.log(E.selectedItems)};return{selectAllChanged:L,testFn:e=>{console.log("testFn")},router:b,keycol:g,keyval:v,goBack:()=>b.back(),autoComplete:z,openAdd:async()=>{Object.entries(y.value.cols).forEach((e=>{const[l,t]=e;"hide"!==t.add&&(N.add[l]=t.default||("integer"===t.type||"decimal"===t.type?0:""))})),A.value="add"},remove:async()=>{if(_.value)return;_.value=!0;const e=E.selectedItems;try{await async function(e){let l=[];const{pk:t}=P;l=t?e.map((e=>e[t])):e.map((e=>e.__key)),await o("/api/t4t/remove/"+V,{ids:l})}(e)}catch(l){alert(`Error delete ${l.toString()}`)}_.value=!1,D()},refreshData:D,doAddOrEdit:async()=>{const a=function(e){for(const l in e)if(P.cols[l]){const{rules:t,type:a}=P.cols[l];if(t){const o=$(t,a,l,e);if(o)return{col:l,msg:o}}}return null}(N[A.value]);if(a)return A.value="",alert(`Invalid ${a.col} - ${a.msg}`);if(!_.value){_.value=!0;try{if("add"===A.value)await async function(e){await o(`/api/t4t/create/${V}`,e)}(N.add);else{const a=N.edit,{__key:o}=a,r=((a,o)=>{var s={};for(var r in a)e.call(a,r)&&o.indexOf(r)<0&&(s[r]=a[r]);if(null!=a&&l)for(var r of l(a))o.indexOf(r)<0&&t.call(a,r)&&(s[r]=a[r]);return s})(a,["__key"]);await async function(e,l){await s(`/api/t4t/update/${V}`,l,{__key:e})}(o,r)}}catch(r){alert(`Error ${A.value} ${r.toString()}`)}_.value=!1,A.value="",D()}},csvUpload:async()=>{try{document.querySelector("#upload-dialog").setAttribute("open",!0)}catch(e){}},doUpload:async()=>{!async function(e){if(null===e)return!1;const l=new FormData;l.append("csv-file",e),await o("/api/t4t/upload/"+V,l)}(document.querySelector("mwc-fileupload").getFile())},csvDownload:async()=>{console.log("export",g.value,F);try{const e=await async function(e,l){try{const{data:t}=await a("/api/t4t/find/"+V,{page:0,limit:0,csv:1,filters:JSON.stringify(e),sorter:JSON.stringify(l)});return t}catch(t){return console.log("eee",t.toString()),null}}(g.value?[...F,{col:g.value,op:"=",val:v.value,andOr:"and"}]:F,R);e&&j(e.csv,m.tableName+".csv","text/csv;charset=utf-8;")}catch(e){console.log("csvDownload",e.toString())}},isRequired:e=>{const{required:l,multiKey:t}=y.value.cols[e];return l||t},deleteFilter:e=>F.splice(e,1),addFilter:e=>F.splice(e,0,{col:x[0],op:"=",val:"",andOr:"and"}),showFilter:S,filters:F,filterCols:x,filterOps:U,showForm:A,recordObj:N,page:h,records:w,rowsPerPage:k,maxPage:C,headerCols:O,tableCfg:y,loading:_}}},_=S("data-v-fc06778e");m("data-v-fc06778e");const N={key:0},E={id:"upload-dialog",open:!1,heading:"Upload CSV"},R=v("p",null,"Upload CSV Files Here",-1),I=v("mwc-fileupload",null,null,-1),D=v("mwc-button",{slot:"secondaryAction",dialogAction:"close"},"Cancel",-1),z={class:"container"},L={class:"navbar"},J={class:"nav-left"},T={class:"nav-item"},B={class:"nav-item"},M={key:0,class:"nav-item"},W={key:1,class:"nav-item"},G={class:"nav-item"},H={class:"nav-item"},K={key:2,class:"nav-item"},Q={class:"nav-right"},X={class:"nav-item"},Y=F(" Rows Per Page "),Z={class:"nav-item"},ee=F("Page"),le={key:0},te=v("option",{value:"and"},"And",-1),ae=v("option",{value:"or"},"Or",-1),oe={key:1},se={class:"filter-row"},re={class:"table"},ne={key:0},ie={key:1,class:"page-flex"},ce={class:"form-box-flex"},de={class:"field-set-flex"};p();const ue=_(((e,l,t,a,o,s)=>(b(),f("div",null,[a.loading?(b(),f("vcxwc-loading-overlay",N)):g("",!0),v("mwc-dialog",E,[R,I,v("mwc-button",{id:"primary-action-button",dialogAction:"close",slot:"primaryAction",onClick:l[1]||(l[1]=(...e)=>a.doUpload&&a.doUpload(...e))},"Upload"),D]),y(v("div",z,[v("nav",L,[v("ul",J,[v("li",T,[v("mwc-icon-button",{icon:"search",onClick:l[2]||(l[2]=e=>a.showFilter=!a.showFilter)})]),v("li",B,[v("mwc-icon-button",{icon:"refresh",onClick:l[3]||(l[3]=(...e)=>a.refreshData&&a.refreshData(...e)),disabled:a.loading},null,8,["disabled"])]),a.tableCfg&&a.tableCfg.create?(b(),f("li",M,[v("mwc-icon-button",{icon:"add",onClick:l[4]||(l[4]=(...e)=>a.openAdd&&a.openAdd(...e)),disabled:a.loading},null,8,["disabled"])])):g("",!0),a.tableCfg&&a.tableCfg.delete?(b(),f("li",W,[v("mwc-icon-button",{icon:"delete",onClick:l[5]||(l[5]=(...e)=>a.remove&&a.remove(...e)),disabled:a.loading},null,8,["disabled"])])):g("",!0),v("li",G,[v("mwc-icon-button",{icon:"post_add",onClick:l[6]||(l[6]=(...e)=>a.csvUpload&&a.csvUpload(...e)),disabled:a.loading},null,8,["disabled"])]),v("li",H,[v("mwc-icon-button",{icon:"move_to_inbox",onClick:l[7]||(l[7]=(...e)=>a.csvDownload&&a.csvDownload(...e)),disabled:a.loading},null,8,["disabled"])]),a.keycol?(b(),f("li",K,[v("mwc-icon-button",{icon:"reply",onClick:l[8]||(l[8]=(...e)=>a.goBack&&a.goBack(...e)),disabled:a.loading},null,8,["disabled"])])):g("",!0)]),v("ul",Q,[v("li",X,[Y,y(v("select",{class:"nav-select-page-size","onUpdate:modelValue":l[9]||(l[9]=e=>a.rowsPerPage=e)},[(b(!0),f(w,null,C(t.pageSizeList,(e=>(b(),f("option",{key:e,value:e,selected:e===a.rowsPerPage},x(e),9,["value","selected"])))),128))],512),[[k,a.rowsPerPage]])]),v("li",Z,[ee,y(v("input",{class:"nav-select-page",type:"number","onUpdate:modelValue":l[10]||(l[10]=e=>a.page=e),min:"1",max:a.maxPage},null,8,["max"]),[[O,a.page]]),F(" / "+x(a.maxPage),1)])])]),a.showFilter?U(e.$slots,"filters",{key:0,filters:a.filters,filterCols:a.filterCols,filterOps:a.filterOps},(()=>[a.filters.length?(b(),f("div",le,[(b(!0),f(w,null,C(a.filters,((e,l)=>(b(),f("div",{class:"filter-row",key:l},[y(v("select",{class:"filter-col","onUpdate:modelValue":l=>e.col=l},[(b(!0),f(w,null,C(a.filterCols,((e,t)=>(b(),f("option",{value:e,key:"c"+l+"-"+t},x(e),9,["value"])))),128))],8,["onUpdate:modelValue"]),[[k,e.col]]),y(v("select",{class:"filter-col","onUpdate:modelValue":l=>e.op=l},[(b(!0),f(w,null,C(a.filterOps,((e,t)=>(b(),f("option",{value:e,key:"o"+l+"-"+t},x(e),9,["value"])))),128))],8,["onUpdate:modelValue"]),[[k,e.op]]),y(v("input",{placeholder:"Value",class:"filter-col","onUpdate:modelValue":l=>e.val=l},null,8,["onUpdate:modelValue"]),[[O,e.val]]),y(v("select",{class:"filter-col","onUpdate:modelValue":l=>e.andOr=l},[te,ae],8,["onUpdate:modelValue"]),[[k,e.andOr]]),v("button",{class:"filter-col",onClick:e=>a.deleteFilter(l)},"x",8,["onClick"]),v("button",{class:"filter-col",onClick:e=>a.addFilter(l+1)},"+",8,["onClick"])])))),128))])):(b(),f("div",oe,[v("div",se,[v("button",{class:"filter-col",onClick:l[11]||(l[11]=e=>a.addFilter(0))},"+")])]))])):g("",!0),U(e.$slots,"table",{tableCfg:a.tableCfg,headerCols:a.headerCols,page:a.page,records:a.records,rowsPerPage:a.rowsPerPage,maxPage:a.maxPage},(()=>[v("vaadin-grid",re,[a.tableCfg&&a.tableCfg.multiSelect?(b(),f("vaadin-grid-selection-column",ne)):g("",!0),(b(!0),f(w,null,C(a.headerCols,((e,l)=>(b(),f("vaadin-grid-sort-column",{key:l,path:e.path,header:e.header,width:e.width,autoWidth:!e.width},null,8,["path","header","width","autoWidth"])))),128))])]))],512),[[h,!a.showForm]]),a.showForm&&a.tableCfg?(b(),f("div",ie,[U(e.$slots,"form",{tableCfg:a.tableCfg,recordObj:a.recordObj,showForm:a.showForm},(()=>[v("form",ce,[v("p",null,x("add"!==a.showForm?"Edit":"Add"),1),v("div",de,[(b(!0),f(w,null,C(a.recordObj[a.showForm],((e,l,t)=>(b(),f(w,null,[a.tableCfg.cols[l]?(b(),f(w,{key:0},["link"===a.tableCfg.cols[l].input?y((b(),f("mwc-textfield",{onClick:e=>a.router.push("/"+a.tableCfg.cols[l].options.to+"?keyval="+a.recordObj[a.showForm].__key+"&keycol="+a.tableCfg.cols[l].options.relatedCol),disabled:"",class:"field-item",key:l+t,label:a.tableCfg.cols[l].label,outlined:"",type:"text","onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e},null,8,["onClick","label","onUpdate:modelValue"])),[[O,a.recordObj[a.showForm][l]]]):"readonly"===a.tableCfg.cols[l][a.showForm]?y((b(),f("mwc-textfield",{disabled:"",class:"field-item",key:l+t,label:a.tableCfg.cols[l].label,outlined:"",type:"text","onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e},null,8,["label","onUpdate:modelValue"])),[[O,a.recordObj[a.showForm][l]]]):"number"===a.tableCfg.cols[l].input?y((b(),f("mwc-textfield",{required:a.isRequired(l),class:"field-item",key:l+t,label:a.tableCfg.cols[l].label,outlined:"",type:"number","onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e},null,8,["required","label","onUpdate:modelValue"])),[[O,a.recordObj[a.showForm][l]]]):"datetime"===a.tableCfg.cols[l].input?y((b(),f("mwc-textfield",{required:a.isRequired(l),class:"field-item",key:l+t,label:a.tableCfg.cols[l].label,outlined:"",type:"datetime-local","onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e},null,8,["required","label","onUpdate:modelValue"])),[[O,a.recordObj[a.showForm][l]]]):"date"===a.tableCfg.cols[l].input?y((b(),f("mwc-textfield",{required:a.isRequired(l),class:"field-item",key:l+t,label:a.tableCfg.cols[l].label,outlined:"",type:"date","onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e},null,8,["required","label","onUpdate:modelValue"])),[[O,a.recordObj[a.showForm][l]]]):"time"===a.tableCfg.cols[l].input?y((b(),f("mwc-textfield",{required:a.isRequired(l),class:"field-item",key:l+t,label:a.tableCfg.cols[l].label,outlined:"",type:"time","onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e},null,8,["required","label","onUpdate:modelValue"])),[[O,a.recordObj[a.showForm][l]]]):"select"===a.tableCfg.cols[l].input?(b(),f("mwc-select",{key:l+t,label:a.tableCfg.cols[l].label,value:a.recordObj[a.showForm][l],onChange:e=>a.recordObj[a.showForm][l]=e.target.value},[(b(!0),f(w,null,C(a.tableCfg.cols[l].options,((e,a)=>(b(),f("mwc-list-item",{value:e.key,key:l+t+"-"+a},x(e.text),9,["value"])))),128))],40,["label","value","onChange"])):"multi-select"===a.tableCfg.cols[l].input?y((b(),f("mwc-multiselect",{required:a.isRequired(l),key:l+t,label:a.tableCfg.cols[l].label,"onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e,options:JSON.stringify(a.tableCfg.cols[l].options)},null,8,["required","label","onUpdate:modelValue","options"])),[[O,a.recordObj[a.showForm][l]]]):"autocomplete"===a.tableCfg.cols[l].input?y((b(),f("mwc-autocomplete",{class:l,required:a.isRequired(l),key:l+t,label:a.tableCfg.cols[l].label,"onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e,onSearch:e=>a.autoComplete(e,l,a.showForm)},null,42,["required","label","onUpdate:modelValue","onSearch"])),[[O,a.recordObj[a.showForm][l]]]):y((b(),f("mwc-textfield",{required:a.isRequired(l),class:"field-item",key:l+t,label:a.tableCfg.cols[l].label,outlined:"",type:"text","onUpdate:modelValue":e=>a.recordObj[a.showForm][l]=e},null,8,["required","label","onUpdate:modelValue"])),[[O,a.recordObj[a.showForm][l]]])],64)):g("",!0)],64)))),256))]),v("mwc-button",{type:"button",onClick:l[12]||(l[12]=e=>a.showForm="")},"Cancel"),v("mwc-button",{type:"button",onClick:l[13]||(l[13]=(...e)=>a.doAddOrEdit&&a.doAddOrEdit(...e)),disabled:a.loading},"Confirm",8,["disabled"])])]))])):g("",!0)]))));A.render=ue,A.__scopeId="data-v-fc06778e";export default A;
